{% extends "base.html" %}

{% block content %}
<div class="space-y-8">

  {% if billing_enforced and not subscription_active %}
    <div class="rounded-lg border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-800">
      <p class="font-semibold">Subscription required for device pairing and capture.</p>
      {% if auto_revoked_count %}
        <p class="mt-1">Auto-revoked {{ auto_revoked_count }} active device{% if auto_revoked_count != 1 %}s{% endif %} because no active subscription was found.</p>
      {% else %}
        <p class="mt-1">No active subscription detected. Pairing stays disabled until your subscription is active again.</p>
      {% endif %}
      <p class="mt-2"><a href="/billing/subscribe/" class="font-medium underline">Go to Subscription</a></p>
    </div>
  {% endif %}

  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold text-slate-900">Paired Devices</h1>
  </div>

  <!-- Pairing code section -->
  <div class="rounded-xl bg-white p-6 shadow-sm">
    <h2 class="text-lg font-semibold text-slate-900">Pair a new device</h2>
    <p class="mt-1 text-sm text-slate-500">Generate a pairing code and enter it in the desktop app.</p>

    {% if active_code %}
      <div class="mt-4 rounded-lg border border-blue-200 bg-blue-50 p-4">
        <p class="text-sm text-blue-700">Your pairing code:</p>
        <p class="mt-1 font-mono text-2xl font-bold tracking-widest text-blue-900">{{ active_code.code }}</p>
        <p class="mt-2 text-xs text-blue-600">
          Expires in <span id="countdown" class="font-medium">--:--</span>. Enter this code in the desktop app.
        </p>
      </div>
      <script>
        (function() {
          const expiresAt = new Date("{{ active_code.expires_at|date:'c' }}").getTime();
          const el = document.getElementById('countdown');
          function tick() {
            const diff = Math.max(0, expiresAt - Date.now());
            const mins = Math.floor(diff / 60000);
            const secs = Math.floor((diff % 60000) / 1000);
            el.textContent = mins + ':' + String(secs).padStart(2, '0');
            if (diff <= 0) {
              el.textContent = 'Expired';
              el.classList.add('text-red-600');
              return;
            }
            requestAnimationFrame(tick);
          }
          tick();
        })();
      </script>
    {% elif billing_enforced and not subscription_active %}
      <p class="mt-4 text-sm text-slate-600">Pairing is disabled until your subscription is active.</p>
    {% else %}
      <form method="post" action="{% url 'generate_pairing_code' %}" class="mt-4">
        {% csrf_token %}
        <button type="submit"
                class="rounded-lg bg-slate-900 px-5 py-2.5 text-sm font-medium text-white shadow-sm transition hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-900 focus:ring-offset-2">
          Generate pairing code
        </button>
      </form>
    {% endif %}
  </div>

  <!-- Devices list -->
  <div class="rounded-xl bg-white p-6 shadow-sm">
    <h2 class="text-lg font-semibold text-slate-900">Your devices</h2>

    {% if devices %}
      <div class="mt-4 divide-y divide-slate-100">
        {% for device in devices %}
          <div class="flex items-center justify-between py-4">
            <div class="flex items-center gap-3">
              <div class="flex h-10 w-10 items-center justify-center rounded-full {% if device.is_active %}bg-green-100{% else %}bg-slate-100{% endif %}">
                <svg class="h-5 w-5 {% if device.is_active %}text-green-600{% else %}text-slate-400{% endif %}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25m18 0A2.25 2.25 0 0 0 18.75 3H5.25A2.25 2.25 0 0 0 3 5.25m18 0V12a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 12V5.25" />
                </svg>
              </div>
              <div>
                <p class="text-sm font-medium text-slate-900">{{ device.label|default:"Unnamed device" }}</p>
                <p class="text-xs text-slate-400">
                  Paired {{ device.created_at|date:"M d, Y" }}
                  {% if device.last_seen_at %} · Last seen {{ device.last_seen_at|timesince }} ago{% endif %}
                  {% if not device.is_active %} · <span class="text-red-500">Revoked</span>{% endif %}
                </p>
              </div>
            </div>
            {% if device.is_active %}
              <form method="post" action="{% url 'revoke_device' device.id %}">
                {% csrf_token %}
                <button type="submit"
                        class="rounded-md border border-red-300 px-3 py-1.5 text-xs font-medium text-red-600 transition hover:bg-red-50"
                        onclick="return confirm('Revoke this device? It will need to be re-paired.')">
                  Revoke
                </button>
              </form>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="mt-4 rounded-lg border border-dashed border-slate-300 px-6 py-8 text-center">
        <svg class="mx-auto h-10 w-10 text-slate-300" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25m18 0A2.25 2.25 0 0 0 18.75 3H5.25A2.25 2.25 0 0 0 3 5.25m18 0V12a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 12V5.25" />
        </svg>
        <h3 class="mt-3 text-sm font-medium text-slate-900">No devices paired</h3>
        <p class="mt-1 text-sm text-slate-500">Generate a pairing code above and enter it in the desktop app.</p>
      </div>
    {% endif %}
  </div>

</div>
{% endblock %}
