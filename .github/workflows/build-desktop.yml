name: Build Desktop Installer

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          pip install --upgrade pyinstaller
          pip install -r desktop/requirements.txt

      - name: Download Tesseract installer
        run: |
          $release = Invoke-RestMethod -Uri "https://api.github.com/repos/UB-Mannheim/tesseract/releases/latest" -Headers @{
            "Accept" = "application/vnd.github+json"
            "User-Agent" = "meet-lessons-build"
          }

          $asset = $release.assets |
            Where-Object { $_.name -like "tesseract-ocr-w64-setup-*.exe" } |
            Select-Object -First 1

          if (-not $asset) {
            throw "Could not find Tesseract installer asset (tesseract-ocr-w64-setup-*.exe) in latest UB-Mannheim release."
          }

          $dest = "desktop/installer/$($asset.name)"
          "TESSERACT_INSTALLER=$($asset.name)" | Out-File -FilePath $env:GITHUB_ENV -Append

          Invoke-WebRequest -Uri $asset.browser_download_url -OutFile $dest

      - name: Build MeetLessons.exe with PyInstaller
        working-directory: desktop
        run: |
          pyinstaller `
            --onefile `
            --windowed `
            --name MeetLessons `
            --icon assets/icon.ico `
            main.py

      - name: Install Inno Setup 6
        run: choco install innosetup --yes --no-progress

      - name: Compile installer with Inno Setup
        run: |
          $version = "${{ github.ref_name }}" -replace '^v', ''
          $iss = Get-Content "desktop/installer/MeetLessons.iss" -Raw
          $iss = $iss -replace '#define APP_VERSION ".*"', "#define APP_VERSION `"$version`""
          if (-not $env:TESSERACT_INSTALLER) {
            throw "TESSERACT_INSTALLER was not set. The previous step should write it to GITHUB_ENV."
          }
          $iss = $iss -replace '#define TESSERACT_INSTALLER ".*"', "#define TESSERACT_INSTALLER `"$($env:TESSERACT_INSTALLER)`""
          Set-Content "desktop/installer/MeetLessons_ci.iss" $iss
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "desktop/installer/MeetLessons_ci.iss"
          Remove-Item "desktop/installer/MeetLessons_ci.iss"

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Meet Lessons ${{ github.ref_name }} — Windows Installer"
          body: |
            ## Meet Lessons ${{ github.ref_name }}

            ### Install
            1. Download `MeetLessonsInstaller.exe` below.
            2. Double-click it and follow the wizard.
            3. Tesseract OCR installs automatically — no extra steps needed.

            ### After install
            Open Meet Lessons from the Start Menu or desktop shortcut.
            Pair your device at your Meet Lessons dashboard → **Devices**.
          files: desktop/dist/MeetLessonsInstaller.exe
          draft: false
          prerelease: false
